<html><head><base href="." />
<meta charset="UTF-8">
<title>GESTION DES PELERINS</title>
<link href="styles.css" rel="stylesheet">
<script src="scripts.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* Variables CSS personnalisées */
:root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --accent-color: #e74c3c;
    --background-color: #f8f9fa;
    --text-color: #333;
    --card-bg: white;
}

[data-theme="dark"] {
    --primary-color: #1a2634;
    --secondary-color: #2980b9;
    --accent-color: #c0392b;
    --background-color: #1a1a1a;
    --text-color: #f8f9fa;
    --card-bg: #2c2c2c;
}

/* Update existing styles */
body {
    color: var(--text-color);
    background-color: var(--background-color);
}

/* Animation du header */
.header-animation {
    animation: slideInDown 1s ease-out;
}

/* Animation pour les cartes clients */
.client-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    background: var(--card-bg);
    border-radius: 8px;
    margin: 10px 0;
    padding: 15px;
}

.client-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* Animation du formulaire */
.form-container {
    animation: fadeIn 0.5s ease-out;
}

/* Styles pour les boutons */
.custom-btn {
    background: var(--secondary-color);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    transition: all 0.3s ease;
}

.custom-btn:hover {
    background: var(--primary-color);
    transform: scale(1.05);
}

/* Animation pour le tableau */
.table-container {
    animation: fadeInUp 0.5s ease-out;
}

/* Loading spinner */
.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--secondary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Styles pour le logo */
.logo-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
}

.logo {
    width: 100px;
    height: 100px;
    object-fit: contain;
    animation: fadeIn 1s ease-out;
}

/* Additional Styles for Cards */
.card {
    margin-bottom: 20px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    background-color: var(--card-bg);
    color: var(--text-color);
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

#performanceChart {
    min-height: 300px;
}

/* Add dark mode toggle button styles */
.theme-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    padding: 10px;
    border-radius: 50%;
    background: var(--secondary-color);
    border: none;
    color: white;
    cursor: pointer;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

/* Modal styles */
#loginModal .modal-content {
    background: var(--card-bg);
    color: var(--text-color);
}

#loginModal input {
    background: var(--background-color);
    color: var(--text-color);
    border-color: var(--primary-color);
}

#loginModal input:focus {
    background: var(--background-color);
    color: var(--text-color);
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
}

/* Logout button style */
.logout-btn {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1000;
}

/* Company Info Styles */
.company-info {
    margin-top: 15px;
    font-size: 0.9rem;
}

.company-info p {
    margin-bottom: 5px;
}

.company-info i {
    margin-right: 10px;
    color: var(--secondary-color);
}
</style>
</head>
<body>

<div class="modal fade" id="loginModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Connexion</h5>
            </div>
            <div class="modal-body">
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="mb-3">
                        <label for="username" class="form-label">Nom d'utilisateur</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Mot de passe</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="text-danger mb-3" id="loginError" style="display: none;">
                        Identifiants incorrects
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Se connecter</button>
                </form>
            </div>
        </div>
    </div>
</div>

<button class="theme-toggle" id="themeToggle">
    <i class="fas fa-moon"></i>
</button>
<button class="btn btn-danger logout-btn" onclick="logout()">
    <i class="fas fa-sign-out-alt"></i> Déconnexion
</button>

<div class="container-fluid py-4">
    <div class="row">
        <!-- Left side with existing content -->
        <div class="col-md-8">
            <!-- Header -->
            <header class="header-animation text-center mb-5">
                <div class="logo-container">
                    <img src="C:\Users\HP\Desktop\logi\images\log.png" alt="Logo AAC SERVICES" class="logo">
                    <div>
                        <h1 class="display-4">AAC SERVICES</h1>
                        <h2 class="display-4">GESTION DES PELERINS</h2>
                        <p class="lead">Agence de Voyage - Partenaire Travelport</p>
                        <div class="company-info">
                            <p><i class="fas fa-map-marker-alt"></i> Médina, Angle Blaise Diagne, Dakar</p>
                            <p><i class="fas fa-phone"></i> 78 010 56 56 / 33 821 42 90</p>
                            <p><i class="fas fa-id-card"></i> NINEA: 005940146</p>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Boutons d'action principaux -->
            <div class="row mb-4">
                <div class="col">
                    <button class="custom-btn me-2" onclick="showAddClientForm()">
                        <i class="fas fa-plus"></i> Nouveau Client
                    </button>
                    <button class="custom-btn me-2" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Exporter Excel
                    </button>
                    <button class="custom-btn" onclick="printClients()">
                        <i class="fas fa-print"></i> Imprimer
                    </button>
                </div>
            </div>

            <!-- Formulaire d'ajout/modification -->
            <div class="form-container" id="clientForm" style="display: none;">
                <div class="card shadow">
                    <div class="card-body">
                        <h3 class="card-title" id="formTitle">Nouveau Client</h3>
                        <form id="addClientForm" onsubmit="saveClient(event)" enctype="multipart/form-data">
                            <input type="hidden" id="clientId">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nom</label>
                                    <input type="text" class="form-control" id="nom" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Prénom</label>
                                    <input type="text" class="form-control" id="prenom" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Téléphone</label>
                                    <input type="tel" class="form-control" id="telephone" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Numéro de Passeport</label>
                                    <input type="text" class="form-control" id="passeport" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Prix du Versement</label>
                                    <input type="number" class="form-control" id="versement" required step="0.01">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Photo du Client</label>
                                    <input type="file" class="form-control" id="photo" accept="image/*">
                                    <div id="photoPreview" class="mt-2" style="max-width: 200px;"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Adresse</label>
                                <textarea class="form-control" id="adresse" rows="3"></textarea>
                            </div>
                            <button type="submit" class="custom-btn">Enregistrer</button>
                            <button type="button" class="custom-btn" onclick="cancelForm()">Annuler</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tableau des clients -->
            <div class="table-container">
                <div class="card shadow">
                    <div class="card-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Photo</th>
                                    <th>Nom</th>
                                    <th>Prénom</th>
                                    <th>Email</th>
                                    <th>Téléphone</th>
                                    <th>N° Passeport</th>
                                    <th>Versement</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTableBody">
                                <!-- Les données seront insérées ici dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right side with performance diagram -->
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body">
                    <h3 class="card-title">Performance des Versements</h3>
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
            
            <!-- Monthly stats card -->
            <div class="card shadow mt-4">
                <div class="card-body">
                    <h3 class="card-title">Statistiques Mensuelles</h3>
                    <div class="d-flex justify-content-between mb-3">
                        <div>
                            <h5>Total Clients</h5>
                            <p class="h3" id="totalClients">0</p>
                        </div>
                        <div>
                            <h5>Total Versements</h5>
                            <p class="h3" id="totalVersements">0 XOF</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://kit.fontawesome.com/your-font-awesome-kit.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<script>
// Check if user is logged in
function checkAuth() {
    const isLoggedIn = sessionStorage.getItem('isLoggedIn');
    if (!isLoggedIn) {
        const loginModal = new bootstrap.Modal(document.getElementById('loginModal'), {
            backdrop: 'static',
            keyboard: false
        });
        loginModal.show();
        
        // Hide the main content
        document.querySelector('.container-fluid').style.display = 'none';
    }
}

// Handle login form submission
function handleLogin(event) {
    event.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    if (username.toLowerCase() === 'admin' && password === 'aac2024') {
        sessionStorage.setItem('isLoggedIn', 'true');
        const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
        loginModal.hide();
        
        // Show the main content
        document.querySelector('.container-fluid').style.display = 'block';
        
        // Initialize the application
        refreshClientTable();
    } else {
        document.getElementById('loginError').style.display = 'block';
    }
}

// Add logout functionality
function logout() {
    sessionStorage.removeItem('isLoggedIn');
    location.reload();
}

// Base de données simulée (à remplacer par une vraie base de données)
let clients = JSON.parse(localStorage.getItem('clients')) || [];

// Fonction pour afficher le formulaire d'ajout
function showAddClientForm() {
    document.getElementById('clientForm').style.display = 'block';
    document.getElementById('formTitle').textContent = 'Nouveau Client';
    document.getElementById('addClientForm').reset();
    document.getElementById('clientId').value = '';
}

// Fonction pour annuler le formulaire
function cancelForm() {
    document.getElementById('clientForm').style.display = 'none';
    document.getElementById('addClientForm').reset();
}

// Fonction pour la prévisualisation de la photo
function handlePhotoPreview(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('photoPreview');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded">`;
        }
        reader.readAsDataURL(file);
    }
}

// Fonction pour sauvegarder un client
function saveClient(event) {
    event.preventDefault();
    
    const photoInput = document.getElementById('photo');
    const photoFile = photoInput.files[0];
    
    const processClient = (photoData) => {
        const clientId = document.getElementById('clientId').value;
        const existingClient = clientId ? clients.find(c => c.id === clientId) : null;
        
        // Get the initial versement amount
        const initialVersement = parseFloat(document.getElementById('versement').value) || 0;
        
        const client = {
            id: clientId || Date.now().toString(),
            nom: document.getElementById('nom').value,
            prenom: document.getElementById('prenom').value,
            email: document.getElementById('email').value,
            telephone: document.getElementById('telephone').value,
            passeport: document.getElementById('passeport').value,
            versement: initialVersement,
            adresse: document.getElementById('adresse').value,
            photo: photoData,
            versements: existingClient ? existingClient.versements : [],
            totalVersements: existingClient ? existingClient.totalVersements : 0
        };

        if (clientId) {
            // For existing client, keep the versements history
            const index = clients.findIndex(c => c.id === clientId);
            clients[index] = { ...clients[index], ...client };
        } else {
            // For new clients, create first versement entry if amount > 0
            client.versements = [];
            if (initialVersement > 0) {
                client.versements.push({
                    date: new Date().toISOString(),
                    amount: initialVersement,
                    notes: "Versement initial"
                });
                client.totalVersements = initialVersement;
            } else {
                client.totalVersements = 0;
            }
            clients.push(client);
        }

        localStorage.setItem('clients', JSON.stringify(clients));
        refreshClientTable();
        cancelForm();
    };

    if (photoFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
            processClient(e.target.result);
        };
        reader.readAsDataURL(photoFile);
    } else {
        processClient(null);
    }
}

// Fonction pour éditer un client
function editClient(id) {
    const client = clients.find(c => c.id === id);
    if (client) {
        document.getElementById('clientId').value = client.id;
        document.getElementById('nom').value = client.nom;
        document.getElementById('prenom').value = client.prenom;
        document.getElementById('email').value = client.email;
        document.getElementById('telephone').value = client.telephone;
        document.getElementById('passeport').value = client.passeport;
        document.getElementById('versement').value = client.versement;
        document.getElementById('adresse').value = client.adresse || '';
        
        if (client.photo) {
            document.getElementById('photoPreview').innerHTML = `
                <img src="${client.photo}" class="img-fluid rounded">
            `;
        }
        
        document.getElementById('formTitle').textContent = 'Modifier Client';
        document.getElementById('clientForm').style.display = 'block';
    }
}

// Fonction pour supprimer un client
function deleteClient(id) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce client ?')) {
        const index = clients.findIndex(c => c.id === id);
        if (index !== -1) {
            clients.splice(index, 1);
            localStorage.setItem('clients', JSON.stringify(clients));
            refreshClientTable();
        }
    }
}

// Fonction pour ajouter un nouveau versement
function addPayment(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    
    // Create and show modal for new payment
    const modalContent = `
        <div class="modal fade" id="addPaymentModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Nouveau Versement pour ${client.nom} ${client.prenom}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="paymentForm" onsubmit="savePayment(event, '${clientId}')">
                            <div class="mb-3">
                                <label class="form-label">Montant</label>
                                <input type="number" class="form-control" id="paymentAmount" required step="0.01">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" id="paymentNotes"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Enregistrer</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>`;

    // Remove existing modal if any
    const existingModal = document.getElementById('addPaymentModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalContent);
    const modal = new bootstrap.Modal(document.getElementById('addPaymentModal'));
    modal.show();
}

// Fonction pour sauvegarder un nouveau versement 
function savePayment(event, clientId) {
    event.preventDefault();
    const client = clients.find(c => c.id === clientId);
    if (!client) return;

    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const notes = document.getElementById('paymentNotes').value;

    // Initialize versements array if it doesn't exist
    if (!client.versements) {
        client.versements = [];
    }

    // Add new payment
    const newPayment = {
        date: new Date().toISOString(),
        amount: amount,
        notes: notes
    };
    client.versements.push(newPayment);

    // Update total versements
    client.totalVersements = (client.totalVersements || 0) + amount;

    // Save to localStorage
    localStorage.setItem('clients', JSON.stringify(clients));

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addPaymentModal'));
    modal.hide();

    // Refresh table and client view
    refreshClientTable();
    viewClient(clientId);
}

// Update the viewClient function to handle undefined versements
function viewClient(id) {
    const client = clients.find(c => c.id === id);
    if (client) {
        // Ensure versements array exists
        const versements = client.versements || [];
        
        const versementsHtml = versements.length > 0 ? 
            versements.map((v, index) => `
                <tr>
                    <td>${new Date(v.date).toLocaleString('fr-FR')}</td>
                    <td>${v.amount.toLocaleString('fr-FR', {style: 'currency', currency: 'XOF'})}</td>
                    <td>${v.notes || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="printPaymentReceipt('${client.id}', ${index})" title="Imprimer reçu">
                            <i class="fas fa-print"></i>
                        </button>
                    </td>
                </tr>
            `).join('') : 
            '<tr><td colspan="4" class="text-center">Aucun versement enregistré</td></tr>';

        const modalContent = `
            <div class="modal fade" id="viewClientModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Détails du Client</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-4 text-center mb-3">
                                    ${client.photo ? 
                                        `<img src="${client.photo}" alt="Photo client" class="img-fluid rounded mb-3" style="max-width: 200px;">` :
                                        '<div class="alert alert-info">Aucune photo disponible</div>'
                                    }
                                </div>
                                <div class="col-md-8">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Nom:</strong> ${client.nom}</p>
                                            <p><strong>Prénom:</strong> ${client.prenom}</p>
                                            <p><strong>Email:</strong> ${client.email}</p>
                                            <p><strong>Téléphone:</strong> ${client.telephone}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>N° Passeport:</strong> ${client.passeport}</p>
                                            <p><strong>Total Versements:</strong> ${(client.totalVersements || 0).toLocaleString('fr-FR', {style: 'currency', currency: 'XOF'})}</p>
                                            <p><strong>Adresse:</strong> ${client.adresse || 'Non spécifiée'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <h6>Historique des Versements</h6>
                            <button class="btn btn-primary mb-3" onclick="addPayment('${client.id}')">
                                <i class="fas fa-plus"></i> Nouveau Versement
                            </button>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Montant</th>
                                            <th>Notes</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${versementsHtml}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="printReceipt('${client.id}')">
                                <i class="fas fa-print"></i> Imprimer Reçu
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>`;

        // Remove existing modal if any
        const existingModal = document.getElementById('viewClientModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Add new modal to body
        document.body.insertAdjacentHTML('beforeend', modalContent);
        const modal = new bootstrap.Modal(document.getElementById('viewClientModal'));
        modal.show();
    }
}

// Function to print individual payment receipt
function printPaymentReceipt(clientId, paymentIndex) {
    const client = clients.find(c => c.id === clientId);
    if (!client || !client.versements || !client.versements[paymentIndex]) return;
    
    const payment = client.versements[paymentIndex];
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Reçu de Versement - ${client.nom} ${client.prenom}</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        padding: 20px;
                        max-width: 600px;
                        margin: 0 auto;
                    }
                    .receipt {
                        border: 2px solid #000;
                        padding: 20px;
                        margin-bottom: 20px;
                    }
                    .header {
                        text-align: center;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #000;
                        padding-bottom: 10px;
                    }
                    .payment-info {
                        margin: 20px 0;
                    }
                    .footer {
                        margin-top: 40px;
                        text-align: center;
                        font-size: 0.9em;
                        border-top: 1px solid #000;
                        padding-top: 20px;
                    }
                    .signature {
                        margin-top: 60px;
                        display: flex;
                        justify-content: space-between;
                    }
                    .signature div {
                        border-top: 1px solid #000;
                        width: 200px;
                        text-align: center;
                        padding-top: 5px;
                    }
                    @media print {
                        .no-print {
                            display: none;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="receipt">
                    <div class="header">
                        <h1>REÇU DE VERSEMENT</h1>
                        <h2>AAC SERVICES</h2>
                        <p>Agence de Voyage - Partenaire Travelport</p>
                        <p>Médina, Angle Blaise Diagne, Dakar</p>
                        <p>Tél: 78 010 56 56 / 33 821 42 90</p>
                        <p>NINEA: 005940146</p>
                        <p>Reçu N°: ${clientId}-${paymentIndex + 1}</p>
                    </div>
                    
                    <div class="payment-info">
                        <h3>Informations du Client</h3>
                        <p><strong>Nom:</strong> ${client.nom} ${client.prenom}</p>
                        <p><strong>N° Passeport:</strong> ${client.passeport}</p>
                        <p><strong>Téléphone:</strong> ${client.telephone}</p>
                        
                        <h3>Détails du Versement</h3>
                        <p><strong>Date:</strong> ${new Date(payment.date).toLocaleString('fr-FR')}</p>
                        <p><strong>Montant:</strong> ${payment.amount.toLocaleString('fr-FR', {style: 'currency', currency: 'XOF'})}</p>
                        <p><strong>Notes:</strong> ${payment.notes || '-'}</p>
                    </div>
                    
                    <div class="signature">
                        <div>
                            <p>Client</p>
                        </div>
                        <div>
                            <p>AAC Voyage</p>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p>Merci de votre confiance !</p>
                        <p>AAC SERVICES - Votre partenaire voyage de confiance</p>
                        <p>En partenariat avec Travelport</p>
                        <p>Compagnie B des États-Unis</p>
                    </div>
                </div>
                
                <div class="no-print" style="text-align: center; margin-top: 20px;">
                    <button onclick="window.print()">Imprimer le reçu</button>
                </div>
            </body>
        </html>
    `);
    printWindow.document.close();
}

// Function to print receipt for a client
function printReceipt(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Reçu - ${client.nom} ${client.prenom}</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        padding: 20px;
                        max-width: 800px;
                        margin: 0 auto;
                    }
                    .receipt {
                        border: 2px solid #000;
                        padding: 20px;
                        margin-bottom: 20px;
                    }
                    .header {
                        text-align: center;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #000;
                        padding-bottom: 10px;
                    }
                    .client-info {
                        margin-bottom: 20px;
                    }
                    .payment-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-bottom: 20px;
                    }
                    .payment-table th, .payment-table td {
                        border: 1px solid #000;
                        padding: 8px;
                        text-align: left;
                    }
                    .total {
                        text-align: right;
                        font-weight: bold;
                        margin-top: 20px;
                        border-top: 2px solid #000;
                        padding-top: 10px;
                    }
                    .footer {
                        margin-top: 40px;
                        text-align: center;
                        font-size: 0.9em;
                    }
                    @media print {
                        .no-print {
                            display: none;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="receipt">
                    <div class="header">
                        <h1>REÇU DE PAIEMENT</h1>
                        <h2>AAC SERVICES</h2>
                        <p>Agence de Voyage - Partenaire Travelport</p>
                        <p>Médina, Angle Blaise Diagne, Dakar</p>
                        <p>Tél: 78 010 56 56 / 33 821 42 90</p>
                        <p>NINEA: 005940146</p>
                        <p>Date d'impression: ${new Date().toLocaleString('fr-FR')}</p>
                    </div>
                    
                    <div class="client-info">
                        <h3>Informations Client</h3>
                        <p><strong>Nom:</strong> ${client.nom} ${client.prenom}</p>
                        <p><strong>N° Passeport:</strong> ${client.passeport}</p>
                        <p><strong>Téléphone:</strong> ${client.telephone}</p>
                        <p><strong>Email:</strong> ${client.email}</p>
                    </div>
                    
                    <div class="payments">
                        <h3>Historique des Versements</h3>
                        <table class="payment-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Montant</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(client.versements || []).map(v => `
                                    <tr>
                                        <td>${new Date(v.date).toLocaleString('fr-FR')}</td>
                                        <td>${v.amount.toLocaleString('fr-FR', {style: 'currency', currency: 'XOF'})}</td>
                                        <td>${v.notes || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <div class="total">
                            <p>Total des Versements: ${(client.totalVersements || 0).toLocaleString('fr-FR', {style: 'currency', currency: 'XOF'})}</p>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p>Merci de votre confiance !</p>
                        <p>AAC SERVICES - Votre partenaire voyage de confiance</p>
                        <p>En partenariat avec Travelport</p>
                        <p>Compagnie B des États-Unis</p>
                    </div>
                </div>
                
                <div class="no-print" style="text-align: center; margin-top: 20px;">
                    <button onclick="window.print()">Imprimer le reçu</button>
                </div>
            </body>
        </html>
    `);
    printWindow.document.close();
}

// Fonction pour actualiser le tableau
function refreshClientTable() {
    const tbody = document.getElementById('clientsTableBody');
    tbody.innerHTML = '';
    
    clients.forEach(client => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                ${client.photo ? 
                    `<img src="${client.photo}" alt="Photo" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;">` : 
                    '<span class="badge bg-secondary">Aucune photo</span>'}
            </td>
            <td>${client.nom}</td>
            <td>${client.prenom}</td>
            <td>${client.email}</td>
            <td>${client.telephone}</td>
            <td>${client.passeport}</td>
            <td>${(client.totalVersements || 0).toLocaleString('fr-FR', {style: 'currency', currency: 'XOF'})}</td>
            <td>
                <button class="btn btn-sm btn-info me-1" onclick="viewClient('${client.id}')" title="Voir détails">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-primary me-1" onclick="editClient('${client.id}')" title="Modifier">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger me-1" onclick="deleteClient('${client.id}')" title="Supprimer">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="btn btn-sm btn-success me-1" onclick="addPayment('${client.id}')" title="Nouveau Versement">
                    <i class="fas fa-plus-circle"></i>
                </button>
                <button class="btn btn-sm btn-secondary" onclick="printReceipt('${client.id}')" title="Imprimer reçu">
                    <i class="fas fa-print"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    // Update chart and stats
    updatePerformanceChart();
    updateStats();
}

// Create a new function to handle chart updates
function updatePerformanceChart() {
    // Destroy existing chart if it exists
    if (window.performanceChart instanceof Chart) {
        window.performanceChart.destroy();
    }
    
    // Create new chart
    const ctx = document.getElementById('performanceChart').getContext('2d');
    window.performanceChart = createPerformanceChart(ctx);
}

// Update the createPerformanceChart function to accept context
function createPerformanceChart(ctx) {
    const monthlyData = getMonthlyData();
    
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: monthlyData.labels,
            datasets: [{
                label: 'Versements Mensuels',
                data: monthlyData.values,
                borderColor: 'rgb(52, 152, 219)',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Évolution des Versements'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('fr-FR', {
                                style: 'currency',
                                currency: 'XOF'
                            });
                        }
                    }
                }
            }
        }
    });
}

// Fonction pour calculer les données mensuelles
function getMonthlyData() {
    const monthlyData = {};
    const labels = [];
    const values = [];
    
    // Initialize last 6 months with 0
    for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
        monthlyData[monthYear] = 0;
    }
    
    // Calculate total versements per month
    clients.forEach(client => {
        if (client.versements) {
            client.versements.forEach(versement => {
                const date = new Date(versement.date);
                const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
                if (monthlyData[monthYear] !== undefined) {
                    monthlyData[monthYear] += versement.amount;
                }
            });
        }
    });
    
    // Convert to arrays for chart
    Object.keys(monthlyData).forEach(monthYear => {
        labels.push(monthYear);
        values.push(monthlyData[monthYear]);
    });
    
    return { labels, values };
}

// Fonction pour mettre à jour les statistiques
function updateStats() {
    const totalClientsElement = document.getElementById('totalClients');
    const totalVersementsElement = document.getElementById('totalVersements');
    
    const totalClients = clients.length;
    const totalVersements = clients.reduce((sum, client) => sum + (client.totalVersements || 0), 0);
    
    totalClientsElement.textContent = totalClients;
    totalVersementsElement.textContent = totalVersements.toLocaleString('fr-FR', {
        style: 'currency',
        currency: 'XOF'
    });
}

// Fonction pour exporter vers Excel
function exportToExcel() {
    const workbook = XLSX.utils.book_new();
    const worksheet = XLSX.utils.json_to_sheet(clients);
    
    XLSX.utils.book_append_sheet(workbook, worksheet, "Clients");
    XLSX.writeFile(workbook, "clients.xlsx");
}

// Fonction pour imprimer
function printClients() {
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Liste des Clients</title>
                <style>
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid black; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    .client-photo { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; }
                </style>
            </head>
            <body>
                <h1>Liste des Clients</h1>
                <table>
                    <thead>
                        <tr>
                            <th>Photo</th>
                            <th>Nom</th>
                            <th>Prénom</th>
                            <th>Email</th>
                            <th>Téléphone</th>
                            <th>N° Passeport</th>
                            <th>Versement</th>
                            <th>Adresse</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${clients.map(client => `
                            <tr>
                                <td>${client.photo ? `<img src="${client.photo}" class="client-photo" alt="Photo">` : 'Aucune photo'}</td>
                                <td>${client.nom}</td>
                                <td>${client.prenom}</td>
                                <td>${client.email}</td>
                                <td>${client.telephone}</td>
                                <td>${client.passeport}</td>
                                <td>${parseFloat(client.versement).toLocaleString('fr-FR', {style: 'currency', currency: 'XOF'})}</td>
                                <td>${client.adresse}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </body>
        </html>
    `);
    printWindow.document.close();
}

// Theme toggle functionality
function initTheme() {
    const themeToggle = document.getElementById('themeToggle');
    const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    
    const currentTheme = localStorage.getItem('theme') || 
                        (prefersDarkScheme.matches ? 'dark' : 'light');
    
    if (currentTheme === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }

    themeToggle.addEventListener('click', () => {
        let theme = document.body.getAttribute('data-theme');
        if (theme === 'dark') {
            document.body.removeAttribute('data-theme');
            localStorage.setItem('theme', 'light');
            themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        } else {
            document.body.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        }
        // Properly update the chart with new theme
        updatePerformanceChart();
    });
}

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
    checkAuth(); // Add this line first
    initTheme();
    refreshClientTable();
    document.getElementById('photo').addEventListener('change', handlePhotoPreview);
    updateStats();
});
</script>

</body>
</html>